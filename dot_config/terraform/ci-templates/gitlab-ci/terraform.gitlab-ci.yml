# GitLab CI: Terraform Pipeline
# Generated by tf-new

stages:
  - validate
  - plan
  - apply

variables:
  TF_VERSION: "{{TERRAFORM_VERSION}}"
  AWS_DEFAULT_REGION: "{{AWS_REGION}}"
  TF_IN_AUTOMATION: "true"
  TF_INPUT: "false"

default:
  image:
    name: hashicorp/terraform:$TF_VERSION
    entrypoint: [""]
  before_script:
    - terraform --version
    - cd ${TF_ROOT:-.}

.terraform_init: &terraform_init
  script:
    - terraform init -backend-config="environments/${ENVIRONMENT}/backend.tfvars"

# =============================================================================
# Validate Stage
# =============================================================================

validate:
  stage: validate
  variables:
    ENVIRONMENT: "{{ENVIRONMENT}}"
  script:
    - terraform init -backend=false
    - terraform fmt -check -recursive
    - terraform validate
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

tflint:
  stage: validate
  image: ghcr.io/terraform-linters/tflint:latest
  before_script: []
  script:
    - tflint --init
    - tflint --recursive
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  allow_failure: true

tfsec:
  stage: validate
  image: aquasec/tfsec:latest
  before_script: []
  script:
    - tfsec . --soft-fail
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  allow_failure: true

# =============================================================================
# Plan Stage
# =============================================================================

.plan_template: &plan_template
  stage: plan
  script:
    - terraform init -backend-config="environments/${ENVIRONMENT}/backend.tfvars"
    - terraform plan -var-file="environments/${ENVIRONMENT}/terraform.tfvars" -out=tfplan
    - terraform show -no-color tfplan > plan.txt
  artifacts:
    paths:
      - ${TF_ROOT:-.}/tfplan
      - ${TF_ROOT:-.}/plan.txt
    expire_in: 1 week
    reports:
      terraform: ${TF_ROOT:-.}/plan.txt

plan:dev:
  <<: *plan_template
  variables:
    ENVIRONMENT: dev
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - "environments/dev/**/*"
        - "modules/**/*"
        - "*.tf"

plan:stg:
  <<: *plan_template
  variables:
    ENVIRONMENT: stg
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - "environments/stg/**/*"
        - "modules/**/*"
        - "*.tf"

plan:prod:
  <<: *plan_template
  variables:
    ENVIRONMENT: prod
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - "environments/prod/**/*"
        - "modules/**/*"
        - "*.tf"
  when: manual

# =============================================================================
# Apply Stage
# =============================================================================

.apply_template: &apply_template
  stage: apply
  script:
    - terraform init -backend-config="environments/${ENVIRONMENT}/backend.tfvars"
    - terraform apply -auto-approve tfplan
    - terraform output -json > outputs.json
  artifacts:
    paths:
      - ${TF_ROOT:-.}/outputs.json
    expire_in: 30 days
  dependencies: []

apply:dev:
  <<: *apply_template
  variables:
    ENVIRONMENT: dev
  dependencies:
    - plan:dev
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - "environments/dev/**/*"
        - "modules/**/*"
        - "*.tf"
  environment:
    name: dev
    url: $DEV_URL

apply:stg:
  <<: *apply_template
  variables:
    ENVIRONMENT: stg
  dependencies:
    - plan:stg
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - "environments/stg/**/*"
        - "modules/**/*"
        - "*.tf"
  when: manual
  environment:
    name: stg
    url: $STG_URL

apply:prod:
  <<: *apply_template
  variables:
    ENVIRONMENT: prod
  dependencies:
    - plan:prod
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - "environments/prod/**/*"
        - "modules/**/*"
        - "*.tf"
  when: manual
  environment:
    name: prod
    url: $PROD_URL
