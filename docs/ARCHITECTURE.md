# アーキテクチャ

このドキュメントでは、dotfiles リポジトリの全体設計、セットアップフロー、ディレクトリ構造、設計判断について詳細に解説します。

---

## 目次

- [全体概要](#全体概要)
- [設計思想](#設計思想)
- [セットアップフロー図](#セットアップフロー図)
- [データフロー](#データフロー)
- [ディレクトリ構造詳解](#ディレクトリ構造詳解)
- [マルチプラットフォーム対応](#マルチプラットフォーム対応)
- [テンプレートシステム](#テンプレートシステム)
- [セキュリティ設計](#セキュリティ設計)
- [スクリプトアーキテクチャ](#スクリプトアーキテクチャ)
- [依存関係](#依存関係)
- [拡張ガイド](#拡張ガイド)

---

## 全体概要

このdotfilesは [chezmoi](https://www.chezmoi.io/) で管理され、macOS / Linux / WSL をサポートしています。

### システム構成図

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           dotfiles リポジトリ                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                │
│  │   テンプレート  │    │  暗号化ファイル │    │  スクリプト   │                │
│  │  (*.tmpl)    │    │ (encrypted_*) │    │  (run_*)    │                │
│  └──────┬──────┘    └──────┬──────┘    └──────┬──────┘                │
│         │                  │                  │                         │
│         └─────────┬────────┴─────────┬────────┘                         │
│                   │                  │                                  │
│                   ▼                  ▼                                  │
│            ┌─────────────────────────────┐                             │
│            │         chezmoi            │                             │
│            │  ┌─────────────────────┐   │                             │
│            │  │ テンプレートエンジン  │   │                             │
│            │  │ age 復号           │   │                             │
│            │  │ 差分管理           │   │                             │
│            │  └─────────────────────┘   │                             │
│            └─────────────┬───────────────┘                             │
│                          │                                              │
└──────────────────────────│──────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         ターゲットマシン                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ~/.zshrc          ~/.config/nvim/       ~/.ssh/                       │
│  ~/.vimrc          ~/.config/git/        ~/.local/bin/                 │
│  ~/.tmux.conf      ~/.config/zellij/     ~/workspace/                  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 設計思想

### 基本原則

| 原則 | 説明 | 実装 |
|------|------|------|
| **宣言的管理** | 設定の状態を宣言的に定義 | chezmoi でファイル状態を管理 |
| **冪等性** | 何度実行しても同じ結果 | chezmoi apply は差分のみ適用 |
| **移植性** | 複数プラットフォーム対応 | テンプレートで OS 分岐 |
| **セキュリティ** | 機密情報の安全な管理 | age 暗号化 |
| **最小権限** | 必要最小限の変更 | 差分確認 → 適用の2段階 |

### なぜ chezmoi を選んだか

#### 他ツールとの比較

| 機能 | chezmoi | GNU Stow | yadm | bare git |
|------|---------|----------|------|----------|
| シンボリックリンク | コピー | ✅ | ✅ | - |
| テンプレート | ✅ Go template | ❌ | ✅ 限定的 | ❌ |
| 暗号化 | ✅ age/gpg | ❌ | ✅ GPG | ❌ |
| 差分確認 | ✅ chezmoi diff | ❌ | ❌ | git diff |
| マルチマシン | ✅ テンプレート | 手動分岐 | .gitattributes | 手動分岐 |
| 実行スクリプト | ✅ run_* | ❌ | ❌ | ❌ |

#### chezmoi の利点

1. **コピーベース**: シンボリックリンクではなくコピーなので、ソースを編集しても即座に反映されない（安全）
2. **差分確認**: `chezmoi diff` で適用前に変更内容を確認できる
3. **テンプレート**: Go template でマシン固有の設定を生成
4. **スクリプト**: `run_once_*`, `run_onchange_*` でセットアップを自動化
5. **暗号化**: age で SSH 鍵などを暗号化してリポジトリに含められる

### ツール選定の判断基準

```
┌─────────────────────────────────────────────────────────────────┐
│                    ツール選定フローチャート                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  新しいツールを検討                                              │
│         │                                                       │
│         ▼                                                       │
│  ┌──────────────┐  No   ┌──────────────┐                       │
│  │ Rust製か？    │──────▶│ Go製か？      │                       │
│  └──────┬───────┘       └──────┬───────┘                       │
│         │ Yes                  │ Yes                           │
│         ▼                      ▼                               │
│  ┌──────────────┐       ┌──────────────┐                       │
│  │ 優先採用     │       │ 検討        │                       │
│  └──────────────┘       └──────────────┘                       │
│                                │ No                            │
│                                ▼                               │
│                         ┌──────────────┐                       │
│                         │ 他に代替が   │  No                   │
│                         │ ないか？     │──────▶ 採用見送り      │
│                         └──────┬───────┘                       │
│                                │ Yes                           │
│                                ▼                               │
│                         ┌──────────────┐                       │
│                         │ メンテナンス  │  No                   │
│                         │ 活発か？     │──────▶ 採用見送り      │
│                         └──────┬───────┘                       │
│                                │ Yes                           │
│                                ▼                               │
│                         ┌──────────────┐                       │
│                         │ 採用        │                       │
│                         └──────────────┘                       │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## セットアップフロー図

### 新規 PC セットアップ（詳細版）

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      新規 PC セットアップフロー                          │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  Phase 1: 初期化                                                        │
│  ════════════════                                                       │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 1. chezmoi init                                                  │   │
│  │    └─→ .chezmoi.toml.tmpl から対話入力                          │   │
│  │        ├── email: Git コミット用メールアドレス                   │   │
│  │        ├── name: Git コミット用ユーザー名                        │   │
│  │        ├── githubUser: GitHub ユーザー名                         │   │
│  │        ├── isWork: 業務用マシンフラグ                           │   │
│  │        └── cloneRepos: リポジトリ自動クローンフラグ              │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  Phase 2: 前提条件インストール（run_onchange_before_01）                │
│  ════════════════════════════════════════════════════════               │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ macOS:                          │ Linux/WSL:                     │   │
│  │ ├── Xcode Command Line Tools    │ ├── curl                       │   │
│  │ ├── Rosetta 2 (Apple Silicon)   │ ├── git                        │   │
│  │ └── Homebrew                    │ └── sudo                       │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  Phase 3: パッケージインストール（run_onchange_before_02）              │
│  ════════════════════════════════════════════════════════               │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ macOS:                          │ Linux/WSL:                     │   │
│  │ └── brew bundle (Brewfile)      │ ├── Nix インストール           │   │
│  │                                  │ ├── Home Manager セットアップ   │   │
│  │                                  │ └── home-manager switch        │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  Phase 4: Rust ツールインストール（run_onchange_before_03）             │
│  ════════════════════════════════════════════════════════               │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ cargo install:                                                   │   │
│  │ ├── ripgrep     # 高速 grep                                     │   │
│  │ ├── fd-find     # 高速 find                                     │   │
│  │ ├── bat         # cat + シンタックスハイライト                   │   │
│  │ ├── eza         # モダン ls                                     │   │
│  │ ├── zoxide      # スマート cd                                   │   │
│  │ ├── sheldon     # zsh プラグイン管理                            │   │
│  │ └── zellij      # ターミナルマルチプレクサ                       │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  Phase 5: ファイル展開                                                  │
│  ════════════════════                                                   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ dot_* ─────────────────────────────────────▶ ~/*                │   │
│  │ dot_config/* ──────────────────────────────▶ ~/.config/*        │   │
│  │ encrypted_* ───┬── age 復号 ──────────────▶ 展開先              │   │
│  │                └── key.txt 必須                                  │   │
│  │ *.tmpl ────────┬── テンプレート処理 ──────▶ 展開先              │   │
│  │                └── chezmoi data 変数展開                         │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  Phase 6: シェル設定（run_once_after_01）                               │
│  ════════════════════════════════════════                               │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ ├── zsh をデフォルトシェルに設定                                 │   │
│  │ ├── sheldon lock（プラグインロック）                             │   │
│  │ └── fzf キーバインド設定                                         │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  Phase 7: リポジトリクローン（run_once_after_02）※オプション           │
│  ════════════════════════════════════════════════════════               │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ cloneRepos == true の場合:                                       │   │
│  │ ├── gh auth login（GitHub CLI 認証）                            │   │
│  │ ├── gh repo list（リポジトリ一覧取得）                          │   │
│  │ └── ghq get（各リポジトリをクローン）                           │   │
│  │     └── ~/workspace/github.com/<user>/<repo>                    │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 日常更新フロー

```
┌─────────────────────────────────────────────────────────────────┐
│                      日常更新フロー                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────┐                                           │
│  │ chezmoi update  │  または  make update                       │
│  └────────┬────────┘                                           │
│           │                                                     │
│           ▼                                                     │
│  ┌─────────────────────────────────────────┐                   │
│  │ 1. git pull                             │                   │
│  │    リモートリポジトリから最新を取得       │                   │
│  └────────────────────┬────────────────────┘                   │
│                       │                                         │
│                       ▼                                         │
│  ┌─────────────────────────────────────────┐                   │
│  │ 2. run_onchange_* スクリプト実行         │                   │
│  │    ├── ハッシュ比較で変更検出            │                   │
│  │    └── 変更があれば再実行               │                   │
│  └────────────────────┬────────────────────┘                   │
│                       │                                         │
│                       ▼                                         │
│  ┌─────────────────────────────────────────┐                   │
│  │ 3. chezmoi apply                        │                   │
│  │    ├── テンプレート再評価               │                   │
│  │    ├── 差分のみ適用                     │                   │
│  │    └── 暗号化ファイル再復号（必要時）   │                   │
│  └─────────────────────────────────────────┘                   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 設定編集フロー

```
┌─────────────────────────────────────────────────────────────────┐
│                      設定編集フロー                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────┐                                           │
│  │ chezmoi edit    │  または  make edit                         │
│  └────────┬────────┘                                           │
│           │                                                     │
│           ▼                                                     │
│  ┌─────────────────────────────────────────┐                   │
│  │ 1. ソースファイルを $EDITOR で編集        │                   │
│  │    ~/dotfiles/dot_zshrc                 │                   │
│  └────────────────────┬────────────────────┘                   │
│                       │                                         │
│                       ▼                                         │
│  ┌─────────────────────────────────────────┐                   │
│  │ 2. chezmoi diff                         │                   │
│  │    変更内容を確認（推奨）               │                   │
│  └────────────────────┬────────────────────┘                   │
│                       │                                         │
│                       ▼                                         │
│  ┌─────────────────────────────────────────┐                   │
│  │ 3. chezmoi apply                        │                   │
│  │    ターゲット（~/.zshrc）に適用         │                   │
│  └────────────────────┬────────────────────┘                   │
│                       │                                         │
│                       ▼                                         │
│  ┌─────────────────────────────────────────┐                   │
│  │ 4. git commit & push                    │                   │
│  │    リポジトリにコミット                 │                   │
│  └─────────────────────────────────────────┘                   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## データフロー

### ファイル変換パイプライン

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      ファイル変換パイプライン                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ソースファイル                    処理                  ターゲット      │
│  ──────────────                    ────                  ──────────      │
│                                                                         │
│  dot_zshrc ─────────────────── コピー ──────────────▶ ~/.zshrc         │
│                                                                         │
│  dot_config/git/config.tmpl ── テンプレート ─────────▶ ~/.config/git/   │
│                                  │                       config         │
│                                  │                                      │
│                                  └── {{ .email }}                       │
│                                      {{ .name }}                        │
│                                      {{ .isWork }}                      │
│                                                                         │
│  encrypted_private_dot_ssh/ ─── age 復号 ────────────▶ ~/.ssh/         │
│  private_id_rsa                   │                     id_rsa          │
│                                   │                                     │
│                                   └── key.txt で復号                    │
│                                                                         │
│  executable_verify-setup ────── 実行権限付与 ────────▶ ~/.local/bin/   │
│                                                         verify-setup    │
│                                                                         │
│  private_dot_ssh/ ───────────── chmod 600 ───────────▶ ~/.ssh/         │
│  config                                                  config         │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 状態管理

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         chezmoi 状態管理                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ~/.local/share/chezmoi/                                               │
│  ├── .chezmoi.toml.tmpl          # 設定テンプレート                    │
│  ├── dot_*                       # ソースファイル                      │
│  └── run_*                       # スクリプト                          │
│                                                                         │
│  ~/.config/chezmoi/                                                    │
│  ├── chezmoi.toml                # ローカル設定（生成済み）             │
│  ├── key.txt                     # age 復号キー                        │
│  └── chezmoistate.boltdb         # 状態データベース                    │
│      ├── entryState              # ファイル状態                        │
│      └── scriptState             # スクリプト実行状態                  │
│                                                                         │
│  状態データベースの役割:                                                │
│  ──────────────────────                                                │
│  • run_once_* → 一度だけ実行（実行済みフラグ保存）                     │
│  • run_onchange_* → ハッシュ比較で変更検出                             │
│  • ファイル状態 → 前回適用時の状態を記録                               │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## ディレクトリ構造詳解

### chezmoi 命名規則

| プレフィックス | 展開先/効果 | 例 | 説明 |
|----------------|-------------|-----|------|
| `dot_` | `.` (ドット) | `dot_zshrc` → `~/.zshrc` | 隠しファイル |
| `private_` | chmod 600 | `private_dot_ssh` | 機密ファイル |
| `executable_` | chmod +x | `executable_script` | 実行可能 |
| `*.tmpl` | テンプレート処理 | `config.tmpl` | 変数展開 |
| `encrypted_` | age 復号 | `encrypted_id_rsa` | 暗号化 |
| `empty_` | 空ファイル作成 | `empty_dot_gitkeep` | プレースホルダ |
| `symlink_` | シンボリックリンク | `symlink_dot_vim` | リンク作成 |
| `modify_` | 既存ファイル修正 | `modify_dot_bashrc` | 追記・編集 |
| `create_` | 存在しない時のみ | `create_dot_config` | 初回のみ |
| `remove_` | 削除 | `remove_dot_old` | 削除指示 |
| `run_once_*` | 初回のみ実行 | `run_once_after_setup` | 1回限り |
| `run_onchange_*` | 変更時実行 | `run_onchange_before_` | 変更検出 |
| `run_` | 毎回実行 | `run_script` | 常時実行 |

### スクリプト実行順序

```
┌─────────────────────────────────────────────────────────────────┐
│                    スクリプト実行順序                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  順序   タイプ                        実行タイミング             │
│  ────   ────                          ──────────────             │
│                                                                 │
│  1      run_onchange_before_*         変更時、ファイル展開前     │
│                                                                 │
│  2      run_once_before_*             初回のみ、ファイル展開前   │
│                                                                 │
│  3      [ファイル展開]                 dot_* → ~/*               │
│                                                                 │
│  4      run_once_after_*              初回のみ、ファイル展開後   │
│                                                                 │
│  5      run_onchange_after_*          変更時、ファイル展開後     │
│                                                                 │
│  ※ run_* (プレフィックスなし) は毎回実行                        │
│  ※ 同じプレフィックス内では辞書順で実行                         │
│  ※ 番号付け推奨: run_once_after_01-setup.sh                     │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 主要ディレクトリの役割

```
dotfiles/
├── .chezmoi.toml.tmpl       # chezmoi 設定（対話入力で変数定義）
│                            # → email, name, githubUser, isWork, cloneRepos
│
├── .chezmoiignore           # chezmoi が無視するファイル
│                            # → README.md, Makefile, docs/ など
│
├── Makefile                 # セットアップコマンド（make bootstrap など）
│
├── Brewfile                 # macOS パッケージ定義
│                            # → brew, cask, mas で管理
│
├── dot_zshrc                # ~/.zshrc メインエントリポイント
│                            # → 各モジュールを source
│
├── dot_config/              # ~/.config/ 以下の設定
│   │
│   ├── nvim/                # Neovim 設定
│   │   ├── init.lua         # メイン設定
│   │   └── lua/             # Lua モジュール
│   │
│   ├── zsh/                 # zsh モジュール群
│   │   ├── tools.zsh        # zoxide, fzf, ghq 統合
│   │   ├── peco.zsh         # peco フォールバック
│   │   ├── fzf-worktree.zsh # git worktree + fzf
│   │   ├── mac.zsh          # macOS 固有設定
│   │   ├── linux.zsh        # Linux 固有設定
│   │   └── alias/           # エイリアス定義
│   │       ├── common_alias.zsh
│   │       ├── mac_alias.zsh
│   │       └── linux_alias.zsh
│   │
│   ├── git/                 # Git 設定（XDG 準拠）
│   │   └── config           # ~/.gitconfig の代わり
│   │
│   ├── sheldon/             # zsh プラグイン管理
│   │   └── plugins.toml     # プラグイン定義
│   │
│   ├── zellij/              # ターミナルマルチプレクサ
│   │   └── config.kdl       # KDL 形式の設定
│   │
│   ├── ghostty/             # 推奨ターミナル
│   │   └── config
│   │
│   ├── alacritty/           # フォールバックターミナル
│   │   └── alacritty.toml
│   │
│   └── karabiner/           # キーリマッパー（macOS）
│
├── dot_local/bin/           # カスタムスクリプト
│   ├── executable_verify-setup      # セットアップ検証
│   ├── executable_clone-all-repos   # リポジトリ一括クローン
│   ├── executable_toggle_opacity    # 透過度切り替え
│   └── executable_git-localinfo     # Git 情報表示
│
├── dot_ssh/                 # SSH 設定
│   └── config.tmpl          # SSH config（テンプレート）
│
├── nix/                     # Linux/WSL 用
│   └── home.nix             # Home Manager 設定
│
├── run_onchange_before_01-install-prerequisites.sh.tmpl
├── run_onchange_before_02-install-packages.sh.tmpl
├── run_onchange_before_03-install-rust-tools.sh.tmpl
├── run_once_after_01-setup-shell.sh.tmpl
├── run_once_after_02-clone-repositories.sh.tmpl
│
├── docs/                    # ドキュメント
│   ├── ARCHITECTURE.md      # このファイル
│   ├── TROUBLESHOOTING.md   # トラブルシューティング
│   ├── new-pc-setup.md      # セットアップガイド
│   └── zellij.md            # Zellij ガイド
│
└── .claude/                 # Claude Code 設定
    ├── settings.local.json
    └── rules/               # Claude Code ルール
        ├── core/            # コアルール
        └── backend/         # バックエンドルール
```

---

## マルチプラットフォーム対応

### プラットフォーム別の違い

| 項目 | macOS | Linux | WSL |
|------|-------|-------|-----|
| パッケージ管理 | Homebrew | Nix + Home Manager | Nix + Home Manager |
| 設定ファイル | `Brewfile` | `nix/home.nix` | `nix/home.nix` |
| キーバインド | Karabiner-Elements | - | - |
| フォント管理 | `brew install --cask` | Nix fonts | Nix fonts |
| クリップボード | `pbcopy`/`pbpaste` | `xclip` | Windows 統合 |
| ターミナル | Ghostty/Alacritty | Ghostty/Alacritty | Windows Terminal |

### OS 分岐の実装

```go
// テンプレートでの OS 分岐
{{ if eq .chezmoi.os "darwin" }}
# macOS 固有の設定
export HOMEBREW_PREFIX="/opt/homebrew"
{{ else if eq .chezmoi.os "linux" }}
# Linux 固有の設定
export PATH="$HOME/.nix-profile/bin:$PATH"
{{ end }}

// WSL 検出
{{ if .chezmoi.kernel.osrelease | lower | contains "microsoft" }}
# WSL 固有の設定
export BROWSER="wslview"
{{ end }}
```

### chezmoi 組み込み変数

```yaml
.chezmoi.os              # "darwin", "linux", "windows"
.chezmoi.arch            # "amd64", "arm64"
.chezmoi.hostname        # ホスト名
.chezmoi.username        # ユーザー名
.chezmoi.homeDir         # ホームディレクトリ
.chezmoi.kernel.osrelease # カーネルリリース（WSL検出用）
```

---

## テンプレートシステム

### 変数定義（.chezmoi.toml.tmpl）

```toml
{{- $email := promptString "Git email address" -}}
{{- $name := promptString "Git user name" -}}
{{- $githubUser := promptString "GitHub username" -}}
{{- $isWork := promptBool "Is this a work machine" -}}
{{- $cloneRepos := promptBool "Clone all GitHub repositories to ~/workspace" -}}

[data]
    email = {{ $email | quote }}
    name = {{ $name | quote }}
    githubUser = {{ $githubUser | quote }}
    isWork = {{ $isWork }}
    cloneRepos = {{ $cloneRepos }}
```

### 使用例

```go
// dot_config/git/config.tmpl
[user]
    name = {{ .name }}
    email = {{ .email }}

{{ if .isWork -}}
[url "git@github-work:"]
    insteadOf = https://github.com/company/
{{- end }}

// 条件付きブロック
{{ if eq .chezmoi.os "darwin" -}}
[credential]
    helper = osxkeychain
{{- end }}
```

### テンプレート関数

| 関数 | 説明 | 例 |
|------|------|-----|
| `eq` | 等価比較 | `{{ if eq .chezmoi.os "darwin" }}` |
| `ne` | 不等価比較 | `{{ if ne .email "" }}` |
| `contains` | 文字列含有 | `{{ if contains "microsoft" .kernel }}` |
| `quote` | 文字列クォート | `{{ .email \| quote }}` |
| `lower` | 小文字化 | `{{ .hostname \| lower }}` |
| `include` | ファイル挿入 | `{{ include "partial.tmpl" }}` |

---

## セキュリティ設計

### age 暗号化フロー

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         age 暗号化フロー                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  暗号化（開発マシン）                                                    │
│  ════════════════════                                                   │
│                                                                         │
│  ~/.ssh/id_ed25519                                                     │
│         │                                                               │
│         ▼                                                               │
│  ┌──────────────────────┐                                              │
│  │ chezmoi add          │                                              │
│  │ --encrypt            │                                              │
│  └──────────┬───────────┘                                              │
│             │                                                           │
│             ▼                                                           │
│  ┌──────────────────────┐     ┌──────────────────────┐                │
│  │ age 暗号化           │ ◀── │ 公開鍵               │                │
│  │ (age-keygen)        │     │ (.chezmoi.toml の   │                │
│  └──────────┬───────────┘     │  encryption.recipient)│               │
│             │                 └──────────────────────┘                │
│             ▼                                                           │
│  encrypted_private_dot_ssh/private_id_ed25519                          │
│  (Git にコミット可能)                                                   │
│                                                                         │
│  ────────────────────────────────────────────────────────────────────  │
│                                                                         │
│  復号（新規マシン）                                                      │
│  ════════════════                                                       │
│                                                                         │
│  encrypted_private_dot_ssh/private_id_ed25519                          │
│         │                                                               │
│         ▼                                                               │
│  ┌──────────────────────┐     ┌──────────────────────┐                │
│  │ age 復号            │ ◀── │ 秘密鍵               │                │
│  │                      │     │ (~/.config/chezmoi/  │                │
│  └──────────┬───────────┘     │  key.txt)            │                │
│             │                 └──────────────────────┘                │
│             ▼                                                           │
│  ~/.ssh/id_ed25519                                                     │
│  (パーミッション 600)                                                   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### キー管理

```
┌─────────────────────────────────────────────────────────────────┐
│                        キー管理                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ファイル                     保存場所      Git追跡              │
│  ────────                     ────────      ────────             │
│                                                                 │
│  公開鍵（暗号化用）           .chezmoi.toml  ✅ Yes             │
│  encryption.recipient         [encryption]                      │
│                                                                 │
│  秘密鍵（復号用）             ~/.config/     ❌ No              │
│  key.txt                      chezmoi/                          │
│                                                                 │
│  暗号化済みファイル           dotfiles/      ✅ Yes             │
│  encrypted_*                  リポジトリ                        │
│                                                                 │
│  ⚠️ 重要: key.txt は絶対に Git にコミットしない                 │
│  ⚠️ 新規マシンには安全な方法で転送（AirDrop, USB, SCP）         │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## スクリプトアーキテクチャ

### run_onchange vs run_once

| 種類 | 実行条件 | ユースケース |
|------|----------|-------------|
| `run_once_*` | 初回のみ | シェル設定、初期クローン |
| `run_onchange_*` | ファイル変更時 | パッケージインストール |
| `run_*` | 毎回 | 動的設定 |

### スクリプト設計パターン

```bash
#!/bin/bash
# run_onchange_before_XX-name.sh.tmpl

# 1. 冪等性の確保
if command -v target_command &> /dev/null; then
    echo "Already installed, skipping..."
    exit 0
fi

# 2. OS 分岐
{{ if eq .chezmoi.os "darwin" }}
# macOS 固有の処理
{{ else }}
# Linux 固有の処理
{{ end }}

# 3. エラーハンドリング
set -e  # エラーで停止

# 4. ログ出力
echo "Installing..."
```

---

## 依存関係

### ツール依存グラフ

```
┌─────────────────────────────────────────────────────────────────┐
│                      ツール依存関係                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  chezmoi                                                        │
│     │                                                           │
│     ├── age (暗号化)                                            │
│     │                                                           │
│     └── git (ソース管理)                                        │
│                                                                 │
│  zsh                                                            │
│     │                                                           │
│     ├── sheldon (プラグイン管理)                                │
│     │     │                                                     │
│     │     ├── zsh-autosuggestions                              │
│     │     ├── zsh-syntax-highlighting                          │
│     │     ├── zsh-completions                                  │
│     │     └── zsh-history-substring-search                     │
│     │                                                           │
│     ├── zoxide (ディレクトリジャンプ)                           │
│     │                                                           │
│     ├── fzf (ファジーファインダー)                              │
│     │                                                           │
│     └── ghq (リポジトリ管理)                                    │
│           │                                                     │
│           └── gh (GitHub CLI)                                   │
│                                                                 │
│  ターミナル                                                      │
│     │                                                           │
│     ├── Ghostty (推奨)                                         │
│     │                                                           │
│     └── Alacritty (フォールバック)                             │
│                                                                 │
│  zellij (マルチプレクサ)                                        │
│                                                                 │
│  モダン CLI                                                     │
│     │                                                           │
│     ├── eza (ls)                                               │
│     ├── bat (cat)                                              │
│     ├── ripgrep (grep)                                         │
│     └── fd (find)                                              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 拡張ガイド

### 新しい dotfile を追加

```bash
# 1. ファイルを chezmoi の管理下に追加
chezmoi add ~/.new-config

# 2. テンプレートが必要な場合
chezmoi add --template ~/.new-config

# 3. 暗号化が必要な場合
chezmoi add --encrypt ~/.secret-file

# 4. 確認
chezmoi managed

# 5. コミット
chezmoi cd && git add -A && git commit -m "Add new-config"
```

### 新しいスクリプトを追加

```bash
# 1. スクリプトを作成
# 命名規則: run_{once|onchange}_{before|after}_XX-name.sh.tmpl

cat > ~/dotfiles/run_once_after_99-my-setup.sh.tmpl << 'EOF'
#!/bin/bash
{{ if eq .chezmoi.os "darwin" }}
echo "Setting up macOS specific..."
{{ end }}
EOF

# 2. 実行権限を付与（chezmoi 側で自動処理）

# 3. テスト
chezmoi apply -v
```

### パッケージを追加

**macOS (Homebrew):**
```ruby
# Brewfile に追加
brew "package-name"
cask "app-name"
mas "App Store App", id: 123456789

# 適用
brew bundle --file=~/dotfiles/Brewfile
# または
make packages
```

**Linux/WSL (Home Manager):**
```nix
# nix/home.nix に追加
home.packages = with pkgs; [
  package-name
];

# 適用
home-manager switch
```

---

## 関連ドキュメント

- [README.md](../README.md) - プロジェクト概要
- [TROUBLESHOOTING.md](TROUBLESHOOTING.md) - トラブルシューティング
- [new-pc-setup.md](new-pc-setup.md) - 新規 PC セットアップガイド
- [zellij.md](zellij.md) - Zellij ガイド
- [chezmoi 公式ドキュメント](https://www.chezmoi.io/user-guide/command-overview/)
- [age 暗号化ドキュメント](https://github.com/FiloSottile/age)
