#!/usr/bin/env bash
#
# agent-skills - Agent Skills Package Manager
# Manage skills for AI agents (Claude, Codex, OpenCode)
#
# Usage:
#   agent-skills <command> [options]
#
# Commands:
#   list      List available skills from all sources
#   sync      Install/update skills to target directories
#   update    Update skill sources (git pull)
#   add       Add a skill to enabled list
#   remove    Remove a skill from enabled list
#   status    Show installation status
#   help      Show this help message

set -e

# =============================================================================
# Configuration
# =============================================================================
AGENT_SKILLS_DIR="${AGENT_SKILLS_DIR:-$HOME/.agent-skills}"
CONFIG_FILE="${AGENT_SKILLS_CONFIG:-$HOME/.config/agent-skills/skills.yaml}"
CACHE_DIR="$AGENT_SKILLS_DIR/cache"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# =============================================================================
# Helper Functions
# =============================================================================

print_error() {
  echo -e "${RED}Error:${NC} $1" >&2
}

print_success() {
  echo -e "${GREEN}$1${NC}"
}

print_warning() {
  echo -e "${YELLOW}$1${NC}"
}

print_info() {
  echo -e "${BLUE}$1${NC}"
}

check_dependencies() {
  local missing=()

  if ! command -v yq &>/dev/null; then
    missing+=("yq")
  fi

  if ! command -v git &>/dev/null; then
    missing+=("git")
  fi

  if [[ ${#missing[@]} -gt 0 ]]; then
    print_error "Missing dependencies: ${missing[*]}"
    echo ""
    echo "Install with:"
    if [[ "$(uname)" == "Darwin" ]]; then
      echo "  brew install ${missing[*]}"
    else
      echo "  nix-env -iA nixpkgs.yq-go  # for yq"
      echo "  Or: sudo apt-get install yq"
    fi
    exit 1
  fi
}

ensure_config() {
  if [[ ! -f "$CONFIG_FILE" ]]; then
    print_error "Config file not found: $CONFIG_FILE"
    echo ""
    echo "Create a config file or run 'chezmoi apply' to install dotfiles."
    exit 1
  fi
}

ensure_cache_dir() {
  mkdir -p "$CACHE_DIR"
}

# Read YAML value using yq
# Usage: yaml_get '.targets.claude.enabled'
yaml_get() {
  yq "$1" "$CONFIG_FILE"
}

# Get list from YAML
# Usage: yaml_list '.enabled[]'
yaml_list() {
  yq -r "$1" "$CONFIG_FILE" 2>/dev/null || true
}

# =============================================================================
# Source Management
# =============================================================================

# Clone or update a git source
update_source() {
  local source_name="$1"
  local source_url
  local source_branch
  local source_dir="$CACHE_DIR/$source_name"

  source_url=$(yaml_get ".sources.$source_name.url")
  source_branch=$(yaml_get ".sources.$source_name.branch // \"main\"")

  if [[ "$source_url" == "null" ]]; then
    return 0
  fi

  if [[ -d "$source_dir/.git" ]]; then
    echo "  Updating $source_name..."
    (cd "$source_dir" && git fetch -q origin && git reset -q --hard "origin/$source_branch")
  else
    echo "  Cloning $source_name..."
    git clone -q --depth 1 --branch "$source_branch" "$source_url" "$source_dir"
  fi
}

# Get the skills path within a source
get_source_skills_path() {
  local source_name="$1"
  local source_type
  local source_path

  source_type=$(yaml_get ".sources.$source_name.type")

  case "$source_type" in
    git)
      source_path=$(yaml_get ".sources.$source_name.path // \".\"")
      echo "$CACHE_DIR/$source_name/$source_path"
      ;;
    local)
      source_path=$(yaml_get ".sources.$source_name.path")
      echo "${source_path/#\~/$HOME}"
      ;;
    *)
      echo ""
      ;;
  esac
}

# List all sources
get_sources() {
  yaml_get '.sources | keys | .[]' 2>/dev/null || true
}

# =============================================================================
# Target Management
# =============================================================================

# Get enabled targets
get_targets() {
  yaml_get '.targets | to_entries | .[] | select(.value.enabled == true) | .key' 2>/dev/null || true
}

# Get target path
get_target_path() {
  local target="$1"
  local path
  path=$(yaml_get ".targets.$target.path")
  echo "${path/#\~/$HOME}"
}

# =============================================================================
# Commands
# =============================================================================

cmd_list() {
  echo "Available Skills"
  echo "================"
  echo ""

  local sources
  sources=$(get_sources)

  for source in $sources; do
    local source_type
    source_type=$(yaml_get ".sources.$source.type")
    local skills_path
    skills_path=$(get_source_skills_path "$source")

    if [[ "$source_type" == "git" && ! -d "$skills_path" ]]; then
      print_warning "Source '$source' not cached. Run 'agent-skills update' first."
      continue
    fi

    if [[ ! -d "$skills_path" ]]; then
      print_warning "Skills path not found for '$source': $skills_path"
      continue
    fi

    echo -e "${CYAN}[$source]${NC}"

    # List skill directories (each directory with a skill.md or similar is a skill)
    for skill_dir in "$skills_path"/*/; do
      if [[ -d "$skill_dir" ]]; then
        local skill_name
        skill_name=$(basename "$skill_dir")

        # Check if this skill is enabled
        local enabled_mark=" "
        if yaml_list '.enabled[]' | grep -q "^$source:$skill_name$"; then
          enabled_mark="${GREEN}*${NC}"
        fi

        # Try to get description from skill.md YAML frontmatter or README
        local description=""
        if [[ -f "$skill_dir/skill.md" ]]; then
          # Extract description from YAML frontmatter
          description=$(sed -n '/^---$/,/^---$/p' "$skill_dir/skill.md" | grep '^description:' | sed 's/^description:\s*//' | cut -c1-60)
          if [[ -z "$description" ]]; then
            # Fallback to first heading
            description=$(grep -m1 '^#' "$skill_dir/skill.md" | sed 's/^#\s*//')
          fi
        elif [[ -f "$skill_dir/README.md" ]]; then
          description=$(head -1 "$skill_dir/README.md" | sed 's/^#\s*//')
        fi

        printf " %b %-25s %s\n" "$enabled_mark" "$skill_name" "$description"
      fi
    done
    echo ""
  done

  echo -e "Legend: ${GREEN}*${NC} = enabled"
  echo ""
  echo "Use 'agent-skills add <source>:<skill>' to enable a skill"
}

cmd_sync() {
  echo "Syncing skills to targets..."
  echo ""

  local targets
  targets=$(get_targets)

  if [[ -z "$targets" ]]; then
    print_warning "No enabled targets found."
    return 0
  fi

  local enabled_skills
  enabled_skills=$(yaml_list '.enabled[]')

  if [[ -z "$enabled_skills" ]]; then
    print_warning "No enabled skills found."
    return 0
  fi

  for target in $targets; do
    local target_path
    target_path=$(get_target_path "$target")

    echo -e "${CYAN}Target: $target${NC} ($target_path)"
    mkdir -p "$target_path"

    for skill_ref in $enabled_skills; do
      local source_name="${skill_ref%%:*}"
      local skill_name="${skill_ref#*:}"

      local skills_path
      skills_path=$(get_source_skills_path "$source_name")
      local skill_source="$skills_path/$skill_name"
      local skill_dest="$target_path/$skill_name"

      if [[ ! -d "$skill_source" ]]; then
        print_warning "  Skill not found: $skill_ref"
        continue
      fi

      # Remove existing symlink/directory
      if [[ -L "$skill_dest" || -d "$skill_dest" ]]; then
        rm -rf "$skill_dest"
      fi

      # Create symlink
      ln -sf "$skill_source" "$skill_dest"
      print_success "  $skill_name -> $skill_source"
    done
    echo ""
  done

  print_success "Sync complete!"
}

cmd_update() {
  echo "Updating skill sources..."
  echo ""

  ensure_cache_dir

  local sources
  sources=$(get_sources)

  for source in $sources; do
    local source_type
    source_type=$(yaml_get ".sources.$source.type")

    if [[ "$source_type" == "git" ]]; then
      update_source "$source"
    fi
  done

  echo ""
  print_success "Update complete!"
}

cmd_add() {
  local skill_ref="$1"

  if [[ -z "$skill_ref" ]]; then
    print_error "Usage: agent-skills add <source>:<skill>"
    echo "Example: agent-skills add anthropic:pdf"
    exit 1
  fi

  # Validate format
  if [[ "$skill_ref" != *:* ]]; then
    print_error "Invalid skill format. Use: <source>:<skill>"
    exit 1
  fi

  # Check if already enabled
  if yaml_list '.enabled[]' | grep -q "^$skill_ref$"; then
    print_warning "Skill '$skill_ref' is already enabled"
    return 0
  fi

  # Add to config
  yq -i ".enabled += [\"$skill_ref\"]" "$CONFIG_FILE"
  print_success "Added '$skill_ref' to enabled skills"
  echo ""
  echo "Run 'agent-skills sync' to install"
}

cmd_remove() {
  local skill_ref="$1"

  if [[ -z "$skill_ref" ]]; then
    print_error "Usage: agent-skills remove <source>:<skill>"
    exit 1
  fi

  # Check if enabled
  if ! yaml_list '.enabled[]' | grep -q "^$skill_ref$"; then
    print_warning "Skill '$skill_ref' is not enabled"
    return 0
  fi

  # Remove from config
  yq -i "del(.enabled[] | select(. == \"$skill_ref\"))" "$CONFIG_FILE"
  print_success "Removed '$skill_ref' from enabled skills"
  echo ""
  echo "Note: Symlinks will be removed on next 'agent-skills sync'"
}

cmd_status() {
  echo "Agent Skills Status"
  echo "==================="
  echo ""

  echo "Config file: $CONFIG_FILE"
  echo "Cache dir:   $CACHE_DIR"
  echo ""

  echo -e "${CYAN}Targets:${NC}"
  local all_targets
  all_targets=$(yaml_get '.targets | keys | .[]' 2>/dev/null || true)

  for target in $all_targets; do
    local enabled
    enabled=$(yaml_get ".targets.$target.enabled")
    local path
    path=$(get_target_path "$target")

    local status_icon
    if [[ "$enabled" == "true" ]]; then
      if [[ -d "$path" ]]; then
        status_icon="${GREEN}[OK]${NC}"
      else
        status_icon="${YELLOW}[DIR MISSING]${NC}"
      fi
    else
      status_icon="${YELLOW}[DISABLED]${NC}"
    fi

    printf "  %-12s %b  %s\n" "$target" "$status_icon" "$path"
  done
  echo ""

  echo -e "${CYAN}Sources:${NC}"
  local sources
  sources=$(get_sources)

  for source in $sources; do
    local source_type
    source_type=$(yaml_get ".sources.$source.type")
    local skills_path
    skills_path=$(get_source_skills_path "$source")

    local status_icon
    if [[ "$source_type" == "git" ]]; then
      if [[ -d "$CACHE_DIR/$source/.git" ]]; then
        status_icon="${GREEN}[CACHED]${NC}"
      else
        status_icon="${YELLOW}[NOT CACHED]${NC}"
      fi
    elif [[ "$source_type" == "local" ]]; then
      if [[ -d "$skills_path" ]]; then
        status_icon="${GREEN}[OK]${NC}"
      else
        status_icon="${RED}[NOT FOUND]${NC}"
      fi
    fi

    printf "  %-12s %b  %s\n" "$source" "$status_icon" "$skills_path"
  done
  echo ""

  echo -e "${CYAN}Enabled Skills:${NC}"
  local enabled_skills
  enabled_skills=$(yaml_list '.enabled[]')

  if [[ -z "$enabled_skills" ]]; then
    echo "  (none)"
  else
    for skill in $enabled_skills; do
      echo "  - $skill"
    done
  fi
  echo ""

  # Check installed skills
  echo -e "${CYAN}Installed Skills:${NC}"
  local targets
  targets=$(get_targets)

  for target in $targets; do
    local target_path
    target_path=$(get_target_path "$target")

    if [[ -d "$target_path" ]]; then
      local skill_count
      skill_count=$(find "$target_path" -maxdepth 1 -type l 2>/dev/null | wc -l | tr -d ' ')
      echo "  $target: $skill_count skills installed in $target_path"
    fi
  done
}

cmd_help() {
  cat <<'EOF'
agent-skills - Agent Skills Package Manager

USAGE:
    agent-skills <command> [options]

COMMANDS:
    list        List available skills from all sources
    sync        Install/update skills to target directories
    update      Update skill sources (git pull)
    add         Add a skill to enabled list
    remove      Remove a skill from enabled list
    status      Show installation status
    help        Show this help message

EXAMPLES:
    # Initial setup
    agent-skills update          # Clone/update skill sources
    agent-skills list            # See available skills
    agent-skills sync            # Install enabled skills

    # Add a new skill
    agent-skills add anthropic:skill-creator
    agent-skills sync

    # Remove a skill
    agent-skills remove anthropic:pdf
    agent-skills sync

CONFIGURATION:
    Config file: ~/.config/agent-skills/skills.yaml
    Cache dir:   ~/.agent-skills/cache

    Edit skills.yaml to:
    - Enable/disable targets (claude, codex, opencode)
    - Add new skill sources
    - Manage enabled skills list

EOF
}

# =============================================================================
# Main
# =============================================================================

main() {
  local command="${1:-help}"
  shift || true

  case "$command" in
    list)
      check_dependencies
      ensure_config
      cmd_list "$@"
      ;;
    sync)
      check_dependencies
      ensure_config
      cmd_sync "$@"
      ;;
    update)
      check_dependencies
      ensure_config
      cmd_update "$@"
      ;;
    add)
      check_dependencies
      ensure_config
      cmd_add "$@"
      ;;
    remove)
      check_dependencies
      ensure_config
      cmd_remove "$@"
      ;;
    status)
      check_dependencies
      ensure_config
      cmd_status "$@"
      ;;
    help|--help|-h)
      cmd_help
      ;;
    *)
      print_error "Unknown command: $command"
      echo ""
      cmd_help
      exit 1
      ;;
  esac
}

main "$@"
