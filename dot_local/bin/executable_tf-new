#!/usr/bin/env bash
# =============================================================================
# tf-new - Terraform Project Generator
# Generate new Terraform projects from templates
# =============================================================================

set -euo pipefail

# Configuration
TEMPLATES_DIR="${TF_TEMPLATES_DIR:-$HOME/.config/terraform/templates}"
DEFAULT_AWS_REGION="ap-northeast-1"
DEFAULT_GCP_REGION="asia-northeast1"
DEFAULT_ENVIRONMENT="dev"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# =============================================================================
# Helper Functions
# =============================================================================

print_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

print_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

print_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

usage() {
    cat << EOF
Usage: tf-new <command> [options]

Commands:
    list                    List available templates
    <template> <name>       Create new project from template

Options:
    -r, --region <region>   AWS/GCP region (default: ap-northeast-1 for AWS)
    -e, --env <env>         Environment (dev, stg, prod) (default: dev)
    -p, --project-id <id>   GCP project ID (required for GCP templates)
    --no-git                Don't initialize git repository
    --no-init               Don't run terraform init
    --no-hooks              Don't install pre-commit hooks
    -h, --help              Show this help message

Examples:
    tf-new list
    tf-new aws-basic my-project
    tf-new aws-basic my-project -r us-east-1 -e prod
    tf-new gcp-basic my-project -p my-gcp-project-id

Templates:
EOF
    list_templates "    "
}

list_templates() {
    local prefix="${1:-}"

    if [[ ! -d "$TEMPLATES_DIR" ]]; then
        print_error "Templates directory not found: $TEMPLATES_DIR"
        return 1
    fi

    for template_dir in "$TEMPLATES_DIR"/*/; do
        if [[ -d "$template_dir" ]]; then
            local template_name
            template_name=$(basename "$template_dir")
            local template_yaml="$template_dir/template.yaml"

            if [[ -f "$template_yaml" ]]; then
                local description
                description=$(grep "^description:" "$template_yaml" 2>/dev/null | sed 's/^description: *//' || echo "No description")
                echo -e "${prefix}${GREEN}${template_name}${NC} - ${description}"
            else
                echo -e "${prefix}${GREEN}${template_name}${NC}"
            fi
        fi
    done
}

# =============================================================================
# Template Processing
# =============================================================================

process_template_file() {
    local src="$1"
    local dst="$2"
    local project_name="$3"
    local region="$4"
    local environment="$5"
    local gcp_project_id="${6:-}"

    # Remove .tmpl extension if present
    dst="${dst%.tmpl}"

    # Create destination directory if needed
    mkdir -p "$(dirname "$dst")"

    # Replace placeholders
    sed -e "s/{{PROJECT_NAME}}/$project_name/g" \
        -e "s/{{AWS_REGION}}/$region/g" \
        -e "s/{{GCP_REGION}}/$region/g" \
        -e "s/{{ENVIRONMENT}}/$environment/g" \
        -e "s/{{GCP_PROJECT_ID}}/$gcp_project_id/g" \
        "$src" > "$dst"
}

create_project() {
    local template_name="$1"
    local project_name="$2"
    local region="$3"
    local environment="$4"
    local gcp_project_id="$5"
    local init_git="$6"
    local run_init="$7"
    local install_hooks="$8"

    local template_dir="$TEMPLATES_DIR/$template_name"

    if [[ ! -d "$template_dir" ]]; then
        print_error "Template not found: $template_name"
        echo "Available templates:"
        list_templates "  "
        exit 1
    fi

    # Check for GCP template requirements
    if [[ "$template_name" == gcp-* ]] && [[ -z "$gcp_project_id" ]]; then
        print_error "GCP project ID is required for GCP templates. Use -p or --project-id option."
        exit 1
    fi

    # Set default region based on template type
    if [[ -z "$region" ]]; then
        if [[ "$template_name" == gcp-* ]]; then
            region="$DEFAULT_GCP_REGION"
        else
            region="$DEFAULT_AWS_REGION"
        fi
    fi

    # Create project directory
    if [[ -d "$project_name" ]]; then
        print_error "Directory already exists: $project_name"
        exit 1
    fi

    print_info "Creating project: $project_name from template: $template_name"

    mkdir -p "$project_name"

    # Copy and process all files
    while IFS= read -r -d '' file; do
        local rel_path="${file#$template_dir/}"
        local dst_path="$project_name/$rel_path"

        # Skip template.yaml
        if [[ "$rel_path" == "template.yaml" ]]; then
            continue
        fi

        if [[ "$file" == *.tmpl ]]; then
            # Process template file
            dst_path="${dst_path%.tmpl}"
            process_template_file "$file" "$dst_path" "$project_name" "$region" "$environment" "$gcp_project_id"
        else
            # Copy file as-is
            mkdir -p "$(dirname "$dst_path")"
            cp "$file" "$dst_path"
        fi
    done < <(find "$template_dir" -type f -print0)

    print_success "Project files created"

    # Change to project directory
    cd "$project_name"

    # Initialize git
    if [[ "$init_git" == "true" ]]; then
        if command -v git &> /dev/null; then
            print_info "Initializing git repository..."
            git init -q
            git add .
            print_success "Git repository initialized"
        else
            print_warn "git not found, skipping git initialization"
        fi
    fi

    # Install pre-commit hooks
    if [[ "$install_hooks" == "true" ]] && [[ -f ".pre-commit-config.yaml" ]]; then
        if command -v pre-commit &> /dev/null; then
            print_info "Installing pre-commit hooks..."
            pre-commit install
            print_success "Pre-commit hooks installed"
        else
            print_warn "pre-commit not found, skipping hook installation"
        fi
    fi

    # Initialize TFLint plugins
    if [[ -f ".tflint.hcl" ]]; then
        if command -v tflint &> /dev/null; then
            print_info "Initializing TFLint plugins..."
            tflint --init || print_warn "TFLint plugin initialization failed"
        fi
    fi

    # Run terraform init
    if [[ "$run_init" == "true" ]]; then
        if command -v terraform &> /dev/null; then
            # Find directories with .tf files
            local tf_dirs
            tf_dirs=$(find . -name "*.tf" -type f | xargs -I {} dirname {} | sort -u)

            for tf_dir in $tf_dirs; do
                if [[ -d "$tf_dir" ]]; then
                    print_info "Running terraform init in $tf_dir..."
                    (cd "$tf_dir" && terraform init -backend=false) || print_warn "terraform init failed in $tf_dir"
                fi
            done
            print_success "Terraform initialized"
        else
            print_warn "terraform not found, skipping terraform init"
        fi
    fi

    # Final message
    echo ""
    print_success "Project '$project_name' created successfully!"
    echo ""
    echo "Next steps:"
    echo "  cd $project_name"
    echo "  # Edit terraform.tfvars or backend.tf as needed"
    echo "  terraform plan"
    echo ""
    echo "Run 'tfcheck' to validate your configuration before applying."
}

# =============================================================================
# Main
# =============================================================================

main() {
    local command=""
    local template_name=""
    local project_name=""
    local region=""
    local environment="$DEFAULT_ENVIRONMENT"
    local gcp_project_id=""
    local init_git="true"
    local run_init="true"
    local install_hooks="true"

    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -h|--help)
                usage
                exit 0
                ;;
            list)
                command="list"
                shift
                ;;
            -r|--region)
                region="$2"
                shift 2
                ;;
            -e|--env)
                environment="$2"
                shift 2
                ;;
            -p|--project-id)
                gcp_project_id="$2"
                shift 2
                ;;
            --no-git)
                init_git="false"
                shift
                ;;
            --no-init)
                run_init="false"
                shift
                ;;
            --no-hooks)
                install_hooks="false"
                shift
                ;;
            -*)
                print_error "Unknown option: $1"
                usage
                exit 1
                ;;
            *)
                if [[ -z "$template_name" ]]; then
                    template_name="$1"
                elif [[ -z "$project_name" ]]; then
                    project_name="$1"
                else
                    print_error "Too many arguments"
                    usage
                    exit 1
                fi
                shift
                ;;
        esac
    done

    # Execute command
    case "$command" in
        list)
            echo "Available templates:"
            list_templates "  "
            ;;
        *)
            if [[ -z "$template_name" ]]; then
                usage
                exit 1
            fi

            if [[ -z "$project_name" ]]; then
                print_error "Project name is required"
                usage
                exit 1
            fi

            # Validate environment
            if [[ ! "$environment" =~ ^(dev|stg|prod)$ ]]; then
                print_error "Invalid environment: $environment (must be dev, stg, or prod)"
                exit 1
            fi

            create_project "$template_name" "$project_name" "$region" "$environment" \
                "$gcp_project_id" "$init_git" "$run_init" "$install_hooks"
            ;;
    esac
}

main "$@"
